<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سمسمتي - منتجات مميزة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; }
        .product-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); }
        .spinner { border: 4px solid rgba(255,255,255,.3); border-top: 4px solid #fff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-50 text-right min-h-screen">
    <header class="bg-white p-4 shadow-md flex justify-between items-center sticky top-0 z-10">
        <h1 class="text-2xl font-black text-indigo-800">سماوي ستور ✨</h1>
        <div>
            <button onclick="login()" id="login-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-full text-base font-bold transition duration-300 shadow-lg">دخول</button>
            <button id="admin-btn" onclick="document.getElementById('admin').classList.toggle('hidden')" class="hidden bg-amber-500 hover:bg-amber-600 text-white px-5 py-2 rounded-full text-sm font-bold transition duration-300 shadow-lg">لوحة الإدارة</button>
        </div>
    </header>

    <div id="admin" class="hidden p-6 bg-indigo-900 text-white space-y-4 shadow-inner">
        <h2 class="text-xl font-bold text-center mb-4">إضافة منتج جديد</h2>
        <input type="text" id="p-name" placeholder="اسم المنتج" class="w-full p-3 text-black rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">
        <input type="number" id="p-price" placeholder="السعر (د.ع)" class="w-full p-3 text-black rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">
        <input type="text" id="p-image" placeholder="رابط صورة المنتج (اختياري)" class="w-full p-3 text-black rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400">
        <button onclick="save()" class="w-full bg-green-500 hover:bg-green-600 py-3 rounded-lg font-bold text-lg transition duration-300 shadow-lg flex items-center justify-center" id="save-btn">
            نشر المنتج
            <div id="save-spinner" class="spinner hidden ml-2"></div>
        </button>
        <p id="admin-msg" class="text-center text-sm mt-2 hidden"></p>
    </div>

    <main class="p-6">
        <h2 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">منتجاتنا المميزة</h2>
        <div id="loading-products" class="text-center py-10 text-gray-600 text-lg">
            <div class="spinner mx-auto mb-4 border-indigo-400 border-t-indigo-700"></div>
            جارٍ تحميل المنتجات...
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" id="products"></div>
        <p id="no-products-msg" class="text-center text-gray-500 text-lg mt-10 hidden">لا توجد منتجات حاليًا، كن أول من يضيف منتجاً!</p>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDTUtClavOl1VgKkDbZQ9rU7bOSFyrx7VI",
            authDomain: "smawystore.firebaseapp.com",
            databaseURL: "https://smawystore-default-rtdb.firebaseio.com",
            projectId: "smawystore",
            storageBucket: "smawystore.firebasestorage.app",
            messagingSenderId: "661134709839",
            appId: "1:661134709839:web:f0b227abc50d3ee1aa063a"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        const defaultProductImage = 'https://via.placeholder.com/400x300.png?text=صورة+المنتج'; // صورة افتراضية
        const adminPassword = "822000"; // كلمة مرور الإدارة

        function login() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithRedirect(provider);
        }

        auth.getRedirectResult().then(res => {
            if (res.user) {
                const enteredPassword = prompt("رمز الإدارة (822000) أو اتركه فارغاً للزبائن:");
                if (enteredPassword === adminPassword) {
                    localStorage.setItem("role", "admin");
                    showMessage("تم تسجيل الدخول كمدير!", "success");
                } else {
                    localStorage.setItem("role", "user");
                    showMessage("تم تسجيل الدخول كزبون.", "info");
                }
                location.reload(); // لإعادة تحميل الصفحة وتطبيق الصلاحيات
            }
        }).catch(error => {
            console.error("خطأ في تسجيل الدخول:", error);
            showMessage("حدث خطأ أثناء تسجيل الدخول.", "error");
        });

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-btn').classList.add('hidden');
                if (localStorage.getItem("role") === "admin") {
                    document.getElementById('admin-btn').classList.remove('hidden');
                }
            } else {
                document.getElementById('login-btn').classList.remove('hidden');
                document.getElementById('admin-btn').classList.add('hidden');
                localStorage.removeItem("role"); // مسح صلاحية المدير عند تسجيل الخروج
            }
        });

        db.ref('products').on('value', snap => {
            document.getElementById('loading-products').classList.add('hidden');
            const productsDiv = document.getElementById('products');
            productsDiv.innerHTML = "";
            if (!snap.exists()) {
                document.getElementById('no-products-msg').classList.remove('hidden');
                return;
            }
            document.getElementById('no-products-msg').classList.add('hidden');

            snap.forEach(c => {
                const p = c.val();
                productsDiv.innerHTML += `
                <div class="product-card bg-white p-4 rounded-2xl shadow-lg border border-gray-100 flex flex-col items-center text-center">
                    <img src="${p.image || defaultProductImage}" class="w-full h-40 object-cover rounded-xl mb-3 border border-gray-200">
                    <h3 class="font-bold text-lg text-gray-800 mb-1">${p.name}</h3>
                    <p class="text-indigo-600 font-extrabold text-xl">${Number(p.price).toLocaleString()} د.ع</p>
                    ${localStorage.getItem("role") === "admin" ? `
                        <button onclick="deleteProduct('${c.key}')" class="text-red-500 hover:text-red-700 text-sm mt-3 pt-2 w-full border-t border-gray-100 font-semibold transition duration-300">
                            حذف المنتج
                        </button>` : ''}
                </div>`;
            });
        });

        function showMessage(msg, type = 'info') {
            const msgElement = document.getElementById('admin-msg');
            msgElement.textContent = msg;
            msgElement.classList.remove('hidden', 'text-green-500', 'text-red-500', 'text-blue-500');
            if (type === 'success') msgElement.classList.add('text-green-500');
            else if (type === 'error') msgElement.classList.add('text-red-500');
            else msgElement.classList.add('text-blue-500');
            setTimeout(() => msgElement.classList.add('hidden'), 5000);
        }

        function save() {
            const nameInput = document.getElementById('p-name');
            const priceInput = document.getElementById('p-price');
            const imageInput = document.getElementById('p-image');
            const saveSpinner = document.getElementById('save-spinner');
            const saveBtn = document.getElementById('save-btn');

            const name = nameInput.value;
            const price = priceInput.value;
            const image = imageInput.value;

            if (name && price) {
                saveSpinner.classList.remove('hidden');
                saveBtn.disabled = true; // تعطيل الزر أثناء الحفظ
                db.ref('products').push({ name: name, price: price, image: image || defaultProductImage })
                    .then(() => {
                        showMessage("تم نشر المنتج بنجاح!", "success");
                        nameInput.value = ""; // مسح الحقول
                        priceInput.value = "";
                        imageInput.value = "";
                    })
                    .catch(error => {
                        console.error("خطأ في نشر المنتج:", error);
                        showMessage("خطأ في نشر المنتج: " + error.message, "error");
                    })
                    .finally(() => {
                        saveSpinner.classList.add('hidden');
                        saveBtn.disabled = false; // إعادة تفعيل الزر
                    });
            } else {
                showMessage("الرجاء إدخال اسم المنتج والسعر على الأقل.", "error");
            }
        }

        function deleteProduct(key) {
            if (confirm("هل أنت متأكد من حذف هذا المنتج؟")) {
                db.ref(`products/${key}`).remove()
                    .then(() => showMessage("تم حذف المنتج بنجاح!", "success"))
                    .catch(error => {
                        console.error("خطأ في حذف المنتج:", error);
                        showMessage("خطأ في حذف المنتج: " + error.message, "error");
                    });
            }
        }
    </script>
</body>
</html>
